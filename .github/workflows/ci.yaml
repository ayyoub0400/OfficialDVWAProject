name: CI Build, Test, Scan and Push

on:
    push:
        branches:
            - main
        paths:
            - '!/terraform/**'


    pull_request:
        branches:
            - main
        paths:
            - 'app/**'
            - '.github/workflows/ci.yaml'

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

permissions: 
  actions: read  
  contents: write  
  security-events: write  
  pull-requests: read 


jobs:
  lint:
    uses: ./.github/workflows/linter.yml 

  sast:
    uses: ./.github/workflows/codescans.yml
    secrets:
      SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}

  ecrpush:
    needs: [lint, sast]
    uses: ./.github/workflows/buildscanpush.yml
    secrets:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      AWS_REGION: ${{ secrets.AWS_REGION }}




